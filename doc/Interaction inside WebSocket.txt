портируем игру Rock Paper Scissors in ICQ (RPS)
в Web на html5

Основная идея API: состояние хранится и на клиенте и на сервере, сервер авторитарен,
изменяет состояние на клиенте вызывая функции.


Пример игровой партии с акцентом на взаимодействия.
Пометки '|' справа от описания - период интерактивности и ожидания действий игрока,
в моменты без пометки клиент только ждёт сервер.
┌──────────────────────────────────┬──────────────────────────────────┬──────────────────────────────────┐
|           игрок 1                |            Сервер                |           игрок 2                |
|Приходит с валидной кукой
                                   |Upgrade соединения до websocket,
                                   |вставка в очередь с пометкой '1'.
                                   |
                                   |Ждёт загрузки карты от
                                   |пользователя. Ждёт второго
                                   |пользователя для создания комнаты.
|Запрашивает у игрока конфигурацию
|синих персонажей.
|(координаты на фронте                                                |приходит с валидной кукой
|всегда в нижней части экрана      |Upgrade соединения до websocket,
|  0123456                         |помечает как '2', объединяет с
| 0RRRRRRR  red                    |пользователем '1', создаёт игровую|запрашивает у пользователя
| 1RRRRRRR                         |комнату.                          |конфигурацию синих
| 2.......                                                            |персонажей
| 3.......                                                            |
| 4BBBBBBB  blue <--                                                  |
| 5BBBBBBB                                                            |отправляет конфигурацию
|передаются [x, y]                                                    |персонажей
|                                  |валидирует, отзеркаливает,
|                                  |загружает в карту
|
|отправляет                        |валидирует, не изменяет
|ставит loader                     |загружает в карту
                                   |проверяет, что оба игрока создали
                                   |команду, присылает полное состояние
                                   |обоим игрокам с учётом вращения
|принимает карту, уберает loader   |                                  |принимает карту, уберает loader
                                   |отправляет "ваш ход" первому                                    
|ставит синий флажок ваш ход       |отправляет "ход соперника"         
|ждёт пользователя                                                    |ставит красный флажок
|                                                                     |ход соперника
|                                                                      
|пользователь нажимает на                                               
|персонажа, появляются стрелочки
|ползователь двигает персонажа
|клиент отсылает с какой кординаты
|в какую двигается пользователь
                                   |сервер смотрит, куда перемещается
                                   |персонаж.
                                   |предположим, целевая клетка пуста
                                   |перемещает персонажа на сервере
                                   |в комнате,
                                   |отправляет действие [move]
                                   |пользователю 1
|двигает персонажа в клетку        |отправляет действие [move]
|что в ответе сервера              |пользователю 2 (отзеркаливая
                                   |координаты)
                                                                      |двигает персонажа
                                   |отправляет "ваш ход" второму
|меняет флажок                     |отправляет "ход соперника" первому|меняет флажок
                                                                      |ждёт пользователя
                                                                      |
                                                                      |
                                                                      |пользователь двигает персонажа
                                                                      |клиент отсылает с какой кординаты
                                                                      |в какую двигается пользователь
                                   |сервер смотрит, куда перемещается
                                   |персонаж.
                                   |предположим, в целевой клетке враг
                                   |сервер проверяет первосходство
                                   |предметов персонажей
                                   |предположим, первый победил.
                                   |отправляет действие [attak]
                                   |(кто, кого, цвет обоих,
                                   |кто проиграл)первому
|отрисовывает анимацию,            |отправляет действие [attak]
|убирает одного персонажа          |(кто, кого, цвет обоих,
                                   |кто проиграл)второму
                                   |отправляет обновление оружия      |отрисовывает анимацию,
                                   |первому                           |убирает одного персонажа
|обновляет оружие персонажа
                                   |отправляет "ваш ход" первому
|ставит синий флажок ваш ход       |отправляет "ход соперника"         
|ждёт пользователя                                                    |ставит красный флажок
|                                                                     |ход соперника
|
|Ползователь двигает персонажа,
|клиент отсылает откуда и куда.
                                   |сервер смотрит, куда перемещается
                                   |персонаж.
                                   |предположим, в целевой клетке 
                                   |такой же персонаж, или координаты
                                   |невалидны.
                                   |сервер отсылает заново состояние 
                                   |игровой комнаты, думая, что
                                   |произошло рассогласование
|Сверяет/перерисовывает поле,
|оставляет флажок 'ваш ход'.
|
|
|Игрок пытается ещё раз сходить,
|клиент отсылает откуда и куда.
                                   |сервер смотрит, куда перемещается
                                   |персонаж.
                                   |предположим, в целевой клетке враг
                                   |сервер проверяет первосходство
                                   |предметов персонажей
                                   |предположим, что равные предметы
                                   |
                                   |отправляет обновление оружия врага         
                                   |первому                                   
                                   |/*выбор нового оружия при
                                   |  одинаковом состоянии - целый
                                   |  дополнительный экран. Потом, если
                                   |  успеем, равно как и ловушку. */
                                   |отправляет "ваш ход" второму
                                   |отправляет "ход соперника" первому|меняет флажок
|меняет флажок                                                        |ждёт пользователя
                                                                      |
                                                                      |
                                                                      |ползователь двигает персонажа
                                                                      |клиент отсылает с какой кординаты
                                                                      |в какую двигается пользователь
                                   |сервер смотрит, куда перемещается
                                   |персонаж.
                                   |предположим, оружие врага - флаг
                                   |отсылает действие [gameover]
|отрисовывает менюшку поражения    |(кто победил) первому
|кнопку "играть снова"             |отсылает действие [gameover]
                                   |(кто победил) второму             |отрисовывает менюшку выигрыша,
                                   |уничтожает игровую комнату        |кнопку ещё раз.
                                   |закрывает соединение. 
└──────────────────────────────────┴──────────────────────────────────┴──────────────────────────────────┘

Типы данных, как они передаются между сервером и клиентом.
Координаты:
    [x, y]
    x number 0 <= x <= 6
    y number 0 <= y <= 5

Оружие "weapon"
  string "stone", "scissors", "paper", "flag"

Персонаж
  Цвет "color"
  string "red", "blue"
  Взаимодействовать игрок может только с персонажами синего цвета.

  Оружие "weapon"
  тип оружие или поле отсутствует, если неизвестно

Карта
  Массив 6*7 персонажей или null для пустой клетки.


Заметка для сервера сервере:
  персонаж {
    принадлежность [1, 2]
    оружие [камень, ножницы, бумага, флаг] // флаг как оружие, которое всегда проигрывает
    спалил ли оружие перед соперником
 }


"статус" комнаты, возвращаемый при инициализации.
содержит информацию сервера, но без оружия соперника, если он ещё не принимал участие,
и повёрнутую для второго игрока

for x := 0; x<=6; x++{                        //   0123456
    for y := 0; y <= 5; y++{                  // 0 ABCDEFG
        user2Map[x][y] = serverMap[6-x][5-y]  // 1 HIJKLMN
    }                                         // 2 OPQRSTU
}                                             // 3 utsrqpo
                                              // 4 nmlkjih
                                              // 5 gfedcba


Список handler's, которые необходимо реализовать:
На сервере по http:
    Установление соединения к игре, протокол http, /game/v1/instance1

На сервере внутри websocket:
    Первоначальная загрузка карты
    "upload_map"

    Движение персонажа
    "go_to_cage"

На клиенте внутри websocket:
    Загрузка всей карты
    "download_map"

    Установки статуса чей ход.
    "your_turn"

    Простое движение пресонажа любого игрока.
    "move_character"

    Отрисовка боя, уничтожение одного персонажа.
    "attack"

    Обновление или появление оружия у персонажа.
    "add_weapon"

    Конец игры, отображение торжествующего персонажа с флагом соперника.
    "gameover"


Примеры всех запросов, эталон формата.

"upload_map"
[
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    {
       "color": "blue",
       "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "paper"
    }
  ],
  [
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "flag"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    }
  ]
]

"go_to_cage"
{
  "from": [5, 5]
  "to": [6, 4]
}

"download_map"
[
  [
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    }
  ],
  [
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    },
    {
       "color": "red"
    }
  ],
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  [
    {
       "color": "blue",
       "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "paper"
    }
  ],
  [
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    },
    {
      "color": "blue",
      "weapon": "stone"
    },
    {
      "color": "blue",
      "weapon": "flag"
    },
    {
      "color": "blue",
      "weapon": "scissors"
    },
    {
      "color": "blue",
      "weapon": "paper"
    }
  ]
]

"your_turn"
true

"move_character"
{
  "from": [5, 5]
  "to": [6, 4]
}

"attack"
{
  "winner": {
    "coordinates": [4, 5],
    "weapon": "scissors"
  },
  "loser": {
    "coordinates": [4, 6],
    "weapon": "paper"
  }
}

"add_weapon"
{
  "coordinates": [4, 6],
  "weapon": "paper"
}

"gameover"
{
  "winner_color": "blue"
}
